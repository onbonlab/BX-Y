# 3.   UDP通信指令

​	UDP通信指令是UDP代理使用的指令格式。UDP代理借助面向非链接的UDP协议局域网内广播形式，向控制卡发送远程控制指令，控制卡根据一定的匹配规则处理指令，并同样通过局域网内广播方式回复处理结果。

​	控制卡在接收到UDP协议帧后，会从参数中分析出targetpid 和 targetbarcode进行匹配，匹配成功，控制器才会执行该协议帧中的指令，并作出回复。如果UDP协议帧中不包含targetpid 和 targetbarcode，或者包含这两项但是值为空，表示所有收到该协议帧的控制卡都必须执行其中的指令，并作出回复。

​	控制卡端UDP代理监听非加密报文的端口暂定为10001。控制卡端UDP代理监听加密报的端口暂定为10002。

​    一．加密规则示例

* 控制卡接收加密报文：

|               | N                                                            |
| ------------- | ------------------------------------------------------------ |
| 0x00          | 0x01                                                         |
| 0x01          | 0x12                                                         |
| 0x02  ~  0xC1 | i0b`}f}q}~0(i0|sw0(20KC?Q]_  0>0dw`a{}\|0(20#<"0>0fs`uwfb{v0(0'"Q*##!&&V&''+&V&##"""""#  P%''SP0>0q~{w|ffkbw0(0BQ0>0`w}fwtg\|qf{}\|0(i0\|sw0(20W\|sp~wAw`dw`_}vw0>0{|bgf0(i0Aw`dw`_}vw0(0q~}gv0oooo |

1. 0x00:加密模式（0x01~0x04）
2. 0x01:加密种子（0x00~0xFF）
3. 0x02~0Xbe:加密报文

* 控制卡回复加密报文：

|               | N                                                            |
| ------------- | ------------------------------------------------------------ |
| 0x00          | 0x02                                                         |
| 0x01          | 0x30                                                         |
| 0x02  ~  0xA2 | .0Ki.~.\|.m.~.s.n.oMwW,.`.l.+.1.v.y.w.a.v.e.z.q.6.:.v.g...f.g.x.~\fFd.u.-.r^~\(I;\9M/N<_0T1.).+hX.3.O~FvCrBrBr@bNnL8Y+L)]-D  .8.:.?|DuDwCw3.2.>.NzKzJzJzJ{I.<.<}?.` |

1. 0x00:加密模式（0x01~0x04）
2. 0x01:加密种子（0x00~0xFF）
3. 0x02~0xA2:加密报文

注：示例中原始报文：

控制卡接收报文：

```json
{"protocol":{"name": "YQ-COM2","version": "1.0","targetpid":"50C811344D45594D4110000012B755AB","clienttype":"PC","remotefunction":{"name": "EnableServerMode","input":{"ServerMode":"cloud"}}}}
```

控制卡回复报文：

```json
{"remotefunction": {"name": "enableservermode", "networkdevice": "eth0"}, "targetbarcode": "C0Y2L01805100002", "targetpid": "50C811344D45594D4110000012B755AB"}
```

​    二．加密方式

- 0x01：原始加密种子与数据原文逐字节异或的结果作为密文
- 0x02：原始加密种子数据与原文首字节异或的结果作为密文首字节，同时作为下一字节的种子
- 0x03：加密种子每异或一字节，循环左移一位作为下一字节的种子
- 0x04：加密种子每异或一字节，循环右移一位作为下一字节的种子